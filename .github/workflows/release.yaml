name: Corprus Crucible Manufacturing

on:
  workflow_dispatch:
  pull_request:
  push:
    branches: main
    tags: ['*']

jobs:
  release:
    strategy:
      matrix:
        os: [macos-latest, macos-15-intel, ubuntu-latest, windows-latest]
    
    runs-on: ${{ matrix.os }}
    
    permissions:
      contents: write
      id-token: write
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Run Corprus Crucible
        uses: DreamWeave-MP/StroggForge/.github/actions/corprus-crucible@v4
        with:
          binary_name: 's3lightfixes'
          vt_api_key: ${{ secrets.VT_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

discord-notify:
    name: Discord Notification
    needs: release
    runs-on: ubuntu-latest

    if: needs.release.result == 'success'

    steps:
      - name: Detect Release URL
        id: detect
        shell: bash
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "release_name=${{ github.ref_name }}" >> $GITHUB_OUTPUT
            echo "display_name=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          else
            echo "release_name=development" >> $GITHUB_OUTPUT
            github_sha_hash=${{ github.sha }}
            echo "display_name=${github_sha_hash:0:7}" >> $GITHUB_OUTPUT
          fi

      - name: Discord Webhook Action
        uses: tsickert/discord-webhook@v7.0.0
        with:
          username: DreamWeave
          webhook-url: ${{ secrets.WEBHOOK_URL }}
          avatar-url: "https://avatars.githubusercontent.com/u/138459727?s=400&u=827e40e3dd9c110c15b3bff26eec0144841e657d&v=4"
          embed-title: "${{ github.event.repository.name }} has been updated."
          embed-description: "[${{ needs.release.outputs.display_name }}](https://github.com/DreamWeave-MP/S3LightFixes/releases/tag/${{ needs.release.outputs.release_name }}) is now available on GitHub and the AUR."
          embed-footer-text: "Workflow: ${{ github.run_id }} by: ${{ github.triggering_actor }} at: $(date +%F)"
